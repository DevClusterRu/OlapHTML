<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, shrink-to-fit=no"
		/>

		<title>MVP</title>
		<link rel="stylesheet" href="/assets/css/graphviz.svg.css" />
		<!-- Custom fonts for this template-->
		<link href="/assets/css/all.min.css" rel="stylesheet" type="text/css" />
		<!-- Custom styles for this template-->
		<link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
		<link rel="stylesheet" href="/assets/css/style.css" />
	</head>

	<body id="page-top">
		<!-- Page Wrapper -->
		<main id="wrapper">
			<!-- Sidebar -->
			<div class="sidebar bg-white shadow" id="sidebar">
				<div class="sidebar--inner">
					<button
						id="sidebarBtn"
						class="sidebarBtn btn bg-white d-lg-none rounded-circle mr-3"
					>
						<i class="fa fa-times"></i>
					</button>
					<!-- Sidebar - Brand -->
					<a
						class="navbar sidebar-brand d-flex align-items-center justify-content-center bg-primary text-white"
						href="index.html"
					>
						<div class="sidebar-brand-icon rotate-n-15">
							<i class="fas fa-laugh-wink"></i>
						</div>
						<div class="sidebar-brand-text mx-3">MVP</div>
					</a>

					<div class="sidebar__block">
						<div class="sidebar__settings">
							<div class="d-flex justify-content-between">
								<h3>
									Pool
									<div class="form-check">
										<label
											class="form-check-label"
											style="font-size: 15px"
										>
											<input
												type="checkbox"
												class="form-check-input mt-1"
												value=""
												id="graphUpdate"
											/>
											<small>Autoupdate chart</small>
										</label>
									</div>
								</h3>
								<!-- Button trigger modal -->
								<div
									class="d-flex flex-row align-items-center"
									style="padding: 10px"
								>
									<span
										data-toggle="tooltip"
										data-placement="top"
										title="Add new pool"
									>
										<button
											type="button"
											class="btn btn-primary mr-1"
											data-toggle="modal"
											data-target="#createPool"
										>
											<i class="fas fa-plus-circle"></i>
										</button>
									</span>
									<span
										data-toggle="tooltip"
										data-placement="top"
										title="Reload pool list"
									>
										<button
											type="button"
											class="btn btn-secondary"
											id="poolReload"
										>
											<i class="fas fa-sync-alt"></i>
										</button>
									</span>
								</div>
							</div>
							<div class="pool list-group" id="poolList"></div>
						</div>
					</div>
					<div
						class="sidebar__block tabs"
						style="opacity: 0.6; pointer-events: none; display: none"
					>
						<nav>
							<div class="nav nav-tabs" id="nav-tab" role="tablist">
								<a
									class="nav-item nav-link active"
									id="nav-home-tab"
									data-toggle="tab"
									href="#nav-home"
									role="tab"
									aria-controls="nav-home"
									aria-selected="true"
									>Operator</a
								>
								<a
									class="nav-item nav-link"
									id="nav-profile-tab"
									data-toggle="tab"
									href="#nav-profile"
									role="tab"
									aria-controls="nav-profile"
									aria-selected="false"
									aria-disabled="true"
									>Create Link</a
								>
								<a
									class="nav-item nav-link"
									id="nav-contact-tab"
									data-toggle="tab"
									href="#nav-contact"
									role="tab"
									aria-controls="nav-contact"
									aria-selected="false"
									>Link list</a
								>
							</div>
						</nav>
						<div class="tab-content" id="nav-tabContent">
							<div
								class="tab-pane fade show active"
								id="nav-home"
								role="tabpanel"
								aria-labelledby="nav-home-tab"
							>
								<div class="sidebar__log"></div>
							</div>
							<div
								class="tab-pane fade"
								id="nav-profile"
								role="tabpanel"
								aria-labelledby="nav-profile-tab"
							>
								<div class="form-group">
									<label for="exampleFormControlSelect1"
										>Select parent</label
									>
									<select
										class="form-control"
										id="linkCreateParent"
									></select>
								</div>
								<div class="form-group">
									<label for="exampleFormControlSelect1"
										>Select child</label
									>
									<select
										class="form-control"
										id="linkCreateChild"
									></select>
								</div>
								<button
									class="btn btn-primary chart-reset"
									id="linkCreate"
									data-toggle="tooltip"
									data-placement="top"
									title="Create new link"
								>
									Create new link
								</button>
							</div>
							<div
								class="tab-pane fade"
								id="nav-contact"
								role="tabpanel"
								aria-labelledby="nav-contact-tab"
							>
								<div class="linksList"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- End of Sidebar -->

			<!-- Content Wrapper -->
			<div id="content-wrapper" class="content-wrapper">
				<!-- Topbar -->
				<nav
					class="navbar navbar-expand navbar-light bg-white topbar static-top shadow-sm"
				>
					<!-- Sidebar Toggle (Topbar) -->
					<button
						id="sidebarBtn"
						class="sidebarBtn btn btn-link d-lg-none rounded-circle mr-3"
					>
						<i class="fa fa-bars"></i>
					</button>

					<h3 id="headerTitle" class="navbar-title m-auto">Select the pool</h3>
					<!-- Topbar Navbar -->
					<div class="navbar-nav">
						<div class="topbar-divider d-none d-sm-block"></div>
						<!-- Nav Item - User Information -->
						<div class="user position-relative">
							<div
								aria-haspopup="true"
								aria-expanded="false"
								href="#"
								id="userDropdown"
								role="button"
								data-toggle="dropdown"
							>
								<img
									width="50"
									height="50"
									class="img-profile rounded-circle"
									src="/assets/img/undraw_profile.svg"
								/>
							</div>
							<!-- Dropdown - User Information -->
							<div
								class="dropdown-menu dropdown-menu-right shadow animated--grow-in text-left"
								aria-labelledby="userDropdown"
							>
								<a class="dropdown-item disabled" href="#">
									<i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
									Profile
								</a>
								<a
									class="dropdown-item disabled"
									href="#"
									data-toggle="modal"
									data-target="#logoutModal"
								>
									<i
										class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"
									></i>
									Logout
								</a>
							</div>
						</div>
					</div>
				</nav>
				<!-- End of Topbar -->

				<!-- Begin Page Content -->
				<div class="chart-inner">
					<div id="chart"></div>
				</div>

				<!-- End of Footer -->
			</div>
			<!-- End of Content Wrapper -->
		</main>
		<!-- End of Page Wrapper -->
		<iframe
			id="hiddenframe"
			name="hiddenframe"
			style="
				top: 0;
				width: 0px;
				height: 0px;
				border: 0px;
				position: absolute;
				visibility: hidden;
			"
		></iframe>
		<!-- Modal -->
		<div
			class="modal fade"
			id="createPool"
			tabindex="-1"
			aria-labelledby="exampleModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog">
				<form class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">
							Create pool
						</h5>
						<button
							type="button"
							class="close"
							data-dismiss="modal"
							aria-label="Close"
						>
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="exampleInputEmail1">Title</label>
							<input
								type="email"
								class="form-control"
								id="newPoolName"
								aria-describedby="emailHelp"
								required
							/>
						</div>
						<div class="form-group">
							<label for="exampleInputPassword1"
								>Description</label
							>
							<textarea
								class="form-control"
								id="newPoolDescription"
								rows="3"
							></textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-secondary"
							data-dismiss="modal"
						>
							Close
						</button>
						<button
							type="button"
							class="btn btn-primary"
							data-dismiss="modal"
							id="createNewPool"
						>
							Create
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Logout Modal-->
		<div
			class="modal fade"
			id="logoutModal"
			tabindex="-1"
			role="dialog"
			aria-labelledby="exampleModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">
							Ready to Leave?
						</h5>
						<button
							class="close"
							type="button"
							data-dismiss="modal"
							aria-label="Close"
						>
							<span aria-hidden="true">Ã—</span>
						</button>
					</div>
					<div class="modal-body">
						Select "Logout" below if you are ready to end your
						current session.
					</div>
					<div class="modal-footer">
						<button
							class="btn btn-secondary"
							type="button"
							data-dismiss="modal"
						>
							Cancel
						</button>
						<a class="btn btn-primary" href="login.html">Logout</a>
					</div>
				</div>
			</div>
		</div>

		<div class="dropdown-menu dropdown-menu-sm" id="context-menu">
			<button class="dropdown-item" id="context-menu-del-link" disabled>
				Delete this link
			</button>
			<button class="dropdown-item reload-chart">Reload chart</button>
			<a class="dropdown-item" href="#">Another action</a>
			<a class="dropdown-item" href="#">Something else here</a>
		</div>

		<script>
			let selectedPool;
		</script>

		<script src="/assets/js/jquery-2.1.3.min.js"></script>
		<script src="/assets/js/jquery.mousewheel.min.js"></script>
		<script src="/assets/js/jquery.color.js"></script>
		<script src="/assets/js/bootstrap.bundle.min.js"></script>
		<script src="/assets/js/bootstrap.min.js"></script>
		<script src="/assets/js/jquery.graphviz.svg.js"></script>
		<script src="/assets/js/svg-pan-zoom.min.js"></script>
		<!-- Bootstrap core JavaScript-->

		<script type="text/javascript">
			$("html").tooltip({
				selector: '[data-toggle="tooltip"]',
			});

			$(function () {
				$('[data-toggle="tooltip"]').tooltip();
			});

			$(".dropdown-menu").click(function (e) {
				e.stopPropagation();
			});
			$(".sidebarBtn").click(function () {
				$("#sidebar").toggleClass("show");
				$(this).toggleClass("toggled");
			});

			function initChart(url) {
				$("#chart").unbind().removeData();

				$("#chart").graphviz({
					url: url,
					zoom: false,
					ready: function () {
						var gv = this;
						gv.nodes().click(function () {
							var $set = $();
							$set.push(this);
							$set = $set.add(gv.linkedFrom(this, true));
							$set = $set.add(gv.linkedTo(this, true));
							gv.highlight($set, true);
							gv.bringToFront($set);
						});
						$(document).keydown(function (evt) {
							if (evt.keyCode == 27) {
								gv.highlight();
							}
						});
						svgPanZoom("#graphvizSVG");
					},
				});
			}

			// /api/poolAggregate?poolId=${el._id}
			// /assets/js/dataTest.json
			// /api/poolList
			// /assets/js/Pool.json

			function loadPool() {
				$("#poolList").html("");

				$.get("/api/poolList", function (data) {
					console.log(data);
					let container = $("#poolList");
					for (let i = 0; i < data.length; i++) {
						let el = data[i];
						let block = `
			           <div class="list-group-item list-group-item-action d-flex justify-content-between flex-row align-items-center py-0 px-2  ${
							el.status == "busy" ? `busy` : ``
						}">
			             <button onclick="selectedPool='${el._id}';
									$.get('/api/poolAggregate?poolId=${el._id}',
									function (data) {
										initChart(data);
										$('#headerTitle').html('${el.name}')
									});"
						 class="list-group-item-button" style="color: inherit;">
			               <div class="d-flex w-100 alighn-items-center flex-column">
			                 <h6 class="list-group-item-name">${el.name}</h6>
			                 ${
									el.description
										? `<small class="list-group-item-desc">` +
										  el.description +
										  `</small>`
										: ``
								}
			               </div>
			               <i class="load-spin fas fa-spinner d-flex align-items-center"></i>
			             </button>
			             <div class="d-flex list-group-item-controls">
			               <form enctype="multipart/form-data" method="POST" target="hiddenframe" action="/api/csvPush" class="d-flex flex-column justify-content-center py-2 mr-1">
			                 <input type="hidden" name="pool" value="${el._id}">
			                 <label class="btn btn-secondary m-0"  data-toggle="tooltip"  title="Load CSV">
			                   <input type="file" name="filename"  hidden onchange="this.form.submit();">
			                   <i class="fas fa-file-upload"></i>
			                 </label>
			               </form>
						   <div  class="d-flex flex-column justify-content-center py-2">
								<button class="btn btn-danger m-0 list-group-item-delete" onclick="$.get('/api/poolRemove?poolId=${
									el._id
								}'); setTimeout(() => {loadPool()}, 50);">
									<i class="fas fa-trash-alt"></i>
								</button>
							</div>
			             </div>
			           </div>
			           `;
						container.append(block);
					}
				});
			}

			loadPool();

			$("#poolReload").click(function () {
				loadPool();
			});

			$("#createNewPool").click(function () {
				let newPoolName = $("#newPoolName").val();
				let newPoolDescription = $("#newPoolDescription").val();
				if (newPoolName && newPoolDescription) {
					$.get(
						`/api/poolCreate?name=${newPoolName}&description=${newPoolDescription}`,
						function (data) {
							$("#poolList").append(
								`<div class="list-group-item list-group-item-action d-flex justify-content-between flex-row align-items-center py-0 px-2  ">
			           <button onclick="$.get('/api/poolAggregate?poolId=${data}',function (data) {initChart(data); $('#headerTitle').html('${newPoolName}');})" class="list-group-item-button" style="color: inherit">
			             <div class="d-flex w-100 alighn-items-center flex-column">
			               <h6 class="list-group-item-name">${newPoolName}</h6>
			               ${
								newPoolDescription
									? `<small class="list-group-item-desc">` +
									  newPoolDescription +
									  `</small>`
									: ``
							}
			             </div>
			             <i class="load-spin fas fa-spinner d-flex align-items-center"></i>
			           </button>
			           <div class="d-flex list-group-item-controls">
			             <form enctype="multipart/form-data" method="POST" target="hiddenframe" action="/api/csvPush" class="d-flex flex-column justify-content-center py-2 mr-1">
			               <input type="hidden" name="pool" value="${data}">
			               <label class="btn btn-secondary m-0"  data-toggle="tooltip"  title="Load CSV">
			                 <input type="file" name="filename"  hidden onchange="this.form.submit();">
			                 <i class="fas fa-file-upload"></i>
			               </label>
			             </form>
						 <div  class="d-flex flex-column justify-content-center py-2">
								<button class="btn btn-danger m-0 list-group-item-delete" onclick="$.get('/api/poolRemove?poolId=${data}'); setTimeout(() => {loadPool()}, 50);">
									<i class="fas fa-trash-alt"></i>
								</button>
							</div>
			           </div>
			         </div>
			         `
							);
						}
					);
				} else {
					alert("Error! Please try again later...");
					return false;
				}
			});

			// AUTOUPDATE
			let intID;
			$("#graphUpdate").change(function () {
				if (selectedPool) {
					if (this.checked) {
						intID = setInterval(function () {
							console.log("Enable AutoUpdate Chart");
							$.get(
								`/api/poolAggregate?poolId=${selectedPool}`,
								function (data) {
									initChart(data);
								}
							);
						}, 10000);
					} else {
						console.log("Disabled AutoUpdate");
						clearInterval(intID);
					}
				} else {
					alert("Data is not set.");
					this.checked = false;
				}
			});

			// CONTEXT MENU
			// $("body")
			// 	.on("contextmenu", function (e) {
			// 		var top = e.pageY - 10;
			// 		var left = e.pageX - 90;
			// 		let target = e.target;
			// 		let targetPerent = target.parentElement;
			// 		$("#context-menu")
			// 			.css({
			// 				display: "block",
			// 				top: top,
			// 				left: left,
			// 			})
			// 			.addClass("show");
			// 		return false; //blocks default Webbrowser right click menu
			// 	})
			// 	.on("click", function () {
			// 		$("#context-menu").removeClass("show").hide();
			// 	});

			// $("#context-menu a").on("click", function () {
			// 	$(this).parent().removeClass("show").hide();
			// });

			// document.querySelectorAll(".reload-chart").forEach((element) => {
			// 	$(element).click(function () {
			// 		$.get(`/api/poolAggregate?poolId=${selectedPool}`, function (data) {
			// 			$("#chart").graphviz({ url: data });
			// 		});
			// 	});
			// });
		</script>

	</body>
</html>
