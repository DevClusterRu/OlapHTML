<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, shrink-to-fit=no"
		/>

		<title>MVP</title>
		<link
			rel="apple-touch-icon"
			sizes="180x180"
			href="/assets/favicon/apple-touch-icon.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="/assets/favicon/favicon-32x32.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="/assets/favicon/favicon-16x16.png"
		/>
		<link rel="manifest" href="/assets/favicon/site.webmanifest" />
		<link
			rel="mask-icon"
			href="/assets/favicon/safari-pinned-tab.svg"
			color="#5bbad5"
		/>
		<meta name="msapplication-TileColor" content="#da532c" />
		<meta name="theme-color" content="#ffffff" />

		<link rel="stylesheet" href="/assets/css/graphviz.svg.css" />
		<link rel="stylesheet" href="/assets/css/ion.rangeSlider.min.css" />
		<link href="/assets/css/select2.min.css" rel="stylesheet" />
		<!-- Custom fonts for this template-->
		<link href="/assets/css/all.min.css" rel="stylesheet" type="text/css" />
		<!-- Custom styles for this template-->
		<link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
		<link rel="stylesheet" href="/assets/css/style.css" />
	</head>

	<body id="page-top">
		<!-- Page Wrapper -->
		<main id="wrapper">
			<!-- Sidebar -->
			<div class="sidebar bg-white shadow" id="sidebar">
				<div class="sidebar--inner">
					<button
						id="sidebarBtn"
						class="sidebarBtn btn bg-white d-lg-none rounded-circle mr-3"
					>
						<i class="fa fa-times"></i>
					</button>
					<!-- Sidebar - Brand -->
					<a
						class="navbar sidebar-brand d-flex align-items-center justify-content-center bg-primary text-white"
						href="index.html"
					>
						<div class="sidebar-brand-icon rotate-n-15">
							<i class="fas fa-laugh-wink"></i>
						</div>
						<div class="sidebar-brand-text mx-3">MVP</div>
					</a>

					<div class="sidebar__block pool-list">
						<div class="sidebar__settings">
							<div class="d-flex justify-content-between">
								<h4>
									Pool
									<div class="form-check">
										<label class="form-check-label" style="font-size: 15px">
											<input
												type="checkbox"
												class="form-check-input mt-1"
												value=""
												id="graphUpdate"
											/>
											<small>Autoupdate chart</small>
										</label>
									</div>
								</h4>
								<!-- Button trigger modal -->
								<div
									class="d-flex flex-row align-items-center"
									style="padding: 10px"
								>
									<span title="Add new pool">
										<button
											type="button"
											class="btn btn-primary mr-1"
											data-toggle="modal"
											data-target="#createPool"
										>
											<i class="fas fa-plus-circle"></i>
										</button>
									</span>
									<span
										data-toggle="tooltip"
										data-placement="top"
										title="Reload pool list"
									>
										<button
											type="button"
											class="btn btn-secondary"
											id="poolReload"
										>
											<i class="fas fa-sync-alt"></i>
										</button>
									</span>
								</div>
							</div>
							<div class="pool list-group" id="poolList"></div>
						</div>
					</div>
 <h4>Process explorer filter</h4>
<div class="sidebar__block tabs">
	<div class="pt-2 px-3">
		<h5>Filter by date</h5>
		<div style="width: 70%; margin: 0 auto">
			<input
				type="text"
				class="js-range-slider"
				name="my_range"
				value=""
				id="filterDataRange"
			/>
		</div>
	</div>
	<hr class="my-2" />
	<div class="pt-2 px-3">
		<h5>Filter by event</h5>
		<ul class="d-flex flex-column js-select-events" id="filterEvents"></ul>
	</div>
	<hr class="my-2" />
	<div class="pt-2 px-3">
		<h5>Filter by case</h5>
		<select
			class="js-example-basic-single w-100"
			name="case"
			multiple
			id="filterCase"
		></select>
		<button
			type="submit"
			class="btn btn-primary mt-3 ml-auto d-block w-50"
			id="filterSubmit"
		>
			Filter
		</button>
	</div>
</div>

				</div>
			</div>
			<!-- End of Sidebar -->

			<!-- Content Wrapper -->
			<div id="content-wrapper" class="content-wrapper">
				<!-- Topbar -->
				<nav
					class="
						navbar navbar-expand navbar-light
						bg-white
						topbar
						static-top
						shadow-sm
					"
				>
					<!-- Sidebar Toggle (Topbar) -->
					<button
						id="sidebarBtn"
						class="sidebarBtn btn btn-link d-lg-none rounded-circle mr-3"
					>
						<i class="fa fa-bars"></i>
					</button>

					<ul class="nav nav-pills mx-auto" id="viewSet" role="tablist">
						<li class="nav-item">
							<a
								class="nav-link active"
								id="processGraph-tab"
								data-toggle="pill"
								href="#processGraph"
								role="tab"
								aria-controls="processGraph"
								aria-selected="true"
								>Process explorer</a
							>
						</li>
						<li class="nav-item">
							<a
								class="nav-link"
								id="cubeView-tab"
								data-toggle="pill"
								href="#cubeView"
								role="tab"
								aria-controls="cubeView"
								aria-selected="false"
								>Cube viewer</a
							>
						</li>
					</ul>
					<!-- Topbar Navbar -->
					<!-- <div class="navbar-nav">
						<div class="topbar-divider d-none d-sm-block"></div>

						<div class="user position-relative">
							<div
								aria-haspopup="true"
								aria-expanded="false"
								href="#"
								id="userDropdown"
								role="button"
								data-toggle="dropdown"
							>
								<img
									width="50"
									height="50"
									class="img-profile rounded-circle"
									src="/assets/img/undraw_profile.svg"
								/>
							</div>
							<div
								class="
									dropdown-menu dropdown-menu-right
									shadow
									animated--grow-in
									text-left
								"
								aria-labelledby="userDropdown"
							>
								<a class="dropdown-item disabled" href="#">
									<i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
									Profile
								</a>
								<a
									class="dropdown-item disabled"
									href="#"
									data-toggle="modal"
									data-target="#logoutModal"
								>
									<i
										class="
											fas
											fa-sign-out-alt fa-sm fa-fw
											mr-2
											text-gray-400
										"
									></i>
									Logout
								</a>
							</div>
						</div>
					</div> -->
				</nav>
				<!-- End of Topbar -->

				<div class="index-tab-content" id="pills-tabContent">
					<div
						class="tab-pane fade show active"
						id="processGraph"
						role="tabpanel"
						aria-labelledby="processGraph-tab"
					>
						<!-- Begin Page Content -->
						<div class="chart-inner">
							<div id="chart"></div>
							<div class="node_info" id="node_info"></div>
						</div>
					</div>
					<div
						class="tab-pane fade p-3"
						id="cubeView"
						role="tabpanel"
						aria-labelledby="cubeView-tab"
					>
						<div
							class="
								d-flex
								flex-column flex-sm-row
								align-items-center align-items-sm-end
							"
						>
							<form class="form-group mx-2 mb-0">
								<label for="cubeFilter">Filtering by</label>
								<select
									class="form-control"
									id="cubeFilter"
									onchange="checkCubeFilter()"
								>
									<option value="years">years</option>
									<option value="months">months</option>
									<option value="days">days</option>
								</select>
							</form>
							<div class="form-group mx-2 mb-0">
								<label for="cubeMonth">Select years</label>
								<select
									class="form-control"
									id="cubeYears"
									onchange="checkCubeFilter()"
									disabled
								></select>
							</div>
							<div class="form-group mx-2 mb-0">
								<label for="cubeDays">Select month</label>
								<select
									class="form-control"
									id="cubeMonth"
									onchange="checkCubeFilter()"
									disabled
								></select>
							</div>
							<button
								type="submit"
								class="btn btn-primary m-2 my-sm-0"
								id="cubeFilterSubmit"
							>
								Refresh
							</button>
						</div>

						<div class="cubeView-inner">
							<canvas id="myChart"></canvas>
						</div>
						<table class="table table-hover">
							<thead>
								<tr>
									<th scope="col">Date</th>
									<th scope="col">Cases count</th>
									<th scope="col">Total Sum</th>
								</tr>
							</thead>
							<tbody id="cubeViewTable"></tbody>
						</table>
					</div>
				</div>

				<!-- End of Footer -->
			</div>
			<!-- End of Content Wrapper -->
		</main>
		<!-- End of Page Wrapper -->
		<iframe
			id="hiddenframe"
			name="hiddenframe"
			style="
				top: 0;
				width: 0px;
				height: 0px;
				border: 0px;
				position: absolute;
				visibility: hidden;
			"
		></iframe>
		<!-- Modal -->
		<div
			class="modal fade"
			id="createPool"
			tabindex="-1"
			aria-labelledby="exampleModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog">
				<form class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">
							Create pool
						</h5>
						<button
							type="button"
							class="close"
							data-dismiss="modal"
							aria-label="Close"
						>
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<label for="exampleInputEmail1">Title</label>
							<input
								type="email"
								class="form-control"
								id="newPoolName"
								aria-describedby="emailHelp"
								required
							/>
						</div>
						<div class="form-group">
							<label for="exampleInputPassword1"
								>Description</label
							>
							<textarea
								class="form-control"
								id="newPoolDescription"
								rows="3"
							></textarea>
						</div>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-secondary"
							data-dismiss="modal"
						>
							Close
						</button>
						<button
							type="button"
							class="btn btn-primary"
							data-dismiss="modal"
							id="createNewPool"
						>
							Create
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Logout Modal-->
		<div
			class="modal fade"
			id="logoutModal"
			tabindex="-1"
			role="dialog"
			aria-labelledby="exampleModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="exampleModalLabel">
							Ready to Leave?
						</h5>
						<button
							class="close"
							type="button"
							data-dismiss="modal"
							aria-label="Close"
						>
							<span aria-hidden="true">×</span>
						</button>
					</div>
					<div class="modal-body">
						Select "Logout" below if you are ready to end your
						current session.
					</div>
					<div class="modal-footer">
						<button
							class="btn btn-secondary"
							type="button"
							data-dismiss="modal"
						>
							Cancel
						</button>
						<a class="btn btn-primary" href="login.html">Logout</a>
					</div>
				</div>
			</div>
		</div>

		<div class="dropdown-menu dropdown-menu-sm" id="context-menu">
			<button class="dropdown-item" id="context-menu-del-link" disabled>
				Delete this link
			</button>
			<button class="dropdown-item reload-chart">Reload chart</button>
			<a class="dropdown-item" href="#">Another action</a>
			<a class="dropdown-item" href="#">Something else here</a>
		</div>

		<script>
			let selectedPool,
				dataStart,
				dataEnd,
				dataRangeStart,
				dataRangeEnd,
				copyText,
				filterParam,
				nubOfDay;
			let cubeDataSetBars,
				cubeDataSetLine,
				cubeLabel,
				cubeLabelMonthNumb = [],
				cubeLabelMonth = [],
				cubeLabelYears = [],
				cubeDataBarYears = [],
				cubeDataLineYears = [],
				cubeLabelDays = [],
				cubeDataBarDays = [],
				cubeDataLineDays = [];
		</script>

		<script src="/assets/js/jquery-2.1.3.min.js"></script>
		<script src="/assets/js/jquery.mousewheel.min.js"></script>
		<script src="/assets/js/jquery.color.js"></script>
		<script src="/assets/js/bootstrap.bundle.min.js"></script>
		<script src="/assets/js/bootstrap.min.js"></script>
		<script src="/assets/js/jquery.graphviz.svg.js"></script>
		<script src="/assets/js/svg-pan-zoom.min.js"></script>
		<script src="/assets/js/select2.min.js"></script>
		<script src="/assets/js/ion.rangeSlider.min.js"></script>
		<script src="/assets/js/ds.min.js"></script>
		<script src="/assets/js/chart.min.js"></script>
		<!-- Bootstrap core JavaScript-->
		<!-- MAIN SCRIPT -->
		<script>
			// $("html").tooltip({
			// 	selector: '[data-toggle="tooltip"]',
			// });

			// $(function () {
			// 	$('[data-toggle="tooltip"]').tooltip();
			// });

			$(".dropdown-menu").click(function (e) {
				e.stopPropagation();
			});
			//
			$(".sidebarBtn").click(function () {
				$("#sidebar").toggleClass("show");
				$(this).toggleClass("toggled");
			});

			function copy(id) {
				copyText = document.getElementById(id);
				copyText.select();
				document.execCommand("copy");
			}

			let dragEvent = new DragSelect({
				area: document.querySelector(".js-select-events"),
				selectables: document.querySelectorAll(".js-item"),
				draggability: false,
				callback: function (e) {
					let arr = document.querySelectorAll(".js-item");
					arr.forEach((element) => {
						element.querySelector("input").checked = false;
					});
					e.forEach((element) => {
						element.querySelector("input").checked = true;
					});
				},
			});
		</script>
		<!-- GRAPHICS -->
		<script type="text/javascript">
			// SELECT POOL
			function selectPool(id) {
				selectedPool = `${id}`;
				$("#processGraph-tab").click();

				$.ajax({
					url: `/api2/poolAggregate`,
					type: "POST",
					data: JSON.stringify({ poolId: `${selectedPool}` }),
					contentType: "application/json; charset=utf-8",
					// dataType: "json",
					success: function (data) {
						console.log(data);
						initChart(data);
						// filterEventsList(data.Events);
						// filterCaseList(data.Objects);
						// filterGetData(data.MinTime, data.MaxTime);
					},
				});
				// $.get(`/api/poolAggregate?poolId=${selectedPool}`, function (data) {
				// 	console.log(data);
				// 	initChart(data.Filename);
				// 	filterEventsList(data.Events);
				// 	filterCaseList(data.Objects);
				// 	filterGetData(data.MinTime, data.MaxTime);
				// });

				getDataCube();
			}
			// GENERATE CHART
			function initChart(svgFile) {
				$("#chart").unbind().removeData();
				// console.log(svgFile);
				$("#chart").graphviz({
					url: `/svg/${svgFile}`,
					zoom: false,
					ready: function () {
						var gv = this;
						gv.nodes().click(function () {
							var $set = $();
							$set.push(this);
							$set = $set.add(gv.linkedFrom(this, true));
							$set = $set.add(gv.linkedTo(this, true));
							gv.highlight($set, true);
							gv.bringToFront($set);
							$("#node_info").html("");
							$("#node_info").append(
								"<div class='node_info_inner'></div>"
							);
							$("#node_info .node_info_inner").append(
								`<div class="node_info-name">${$(this).attr(
									"data-name"
								)}</div>`
							);
							$("#node_info .node_info_inner").append(
								`<div class="node_info-text">${$(this).attr(
									"data-comment"
								)}</div>`
							);
						});
						$(document).keydown(function (evt) {
							if (evt.keyCode == 27) {
								gv.highlight();
								$("#node_info").html("");
							}
						});
						svgPanZoom("#graphvizSVG");
						$("g[data-name='[Start]']")
							.find("ellipse")
							.attr("fill", "#4482c4");
						$("g[data-name='[End]']")
							.find("ellipse")
							.attr("fill", "#4482c4");

						$("g[data-name='[Start]']").find("text").attr("fill", "#black");
						$("g[data-name='[End]']").find("text").attr("fill", "#black");
					},
				});
			}
			// GENERATE POOL LIST
			function loadPool() {
				$("#poolList").html("");

				$.get("/api/poolList", function (data) {
					console.log(data);
					let container = $("#poolList");
					for (let i = 0; i < data.length; i++) {
						let el = data[i];
						let block = `
			           <div class="list-group-item list-group-item-action d-flex justify-content-between flex-row align-items-center py-0 px-2  ${
							el.status == "busy" ? `busy` : ``
						}">
			             <button onclick="selectPool('${el._id}');"
						 class="list-group-item-button" style="color: inherit;">
			               <div class="d-flex w-100 alighn-items-center flex-column">
			                 <h6 class="list-group-item-name">${el.name}</h6>
			                 ${
									el.description
										? `<small class="list-group-item-desc">` +
										  el.description +
										  `</small>`
										: ``
								}
			               </div>
			               <i class="load-spin fas fa-spinner d-flex align-items-center"></i>
			             </button>
			             <div class="d-flex list-group-item-controls">
							<div  class="d-flex flex-column justify-content-center py-2 mr-1">
								<!-- Кнопка-триггер модального окна -->
								<button type="button" class="btn btn-primary m-0" data-toggle="modal" data-target="#modal${
									el._id
								}">
									<i class="fas fa-link"></i>
								</button>
							</div>
			               <form enctype="multipart/form-data" method="POST" target="hiddenframe" action="/api2/csvPush" class="d-flex flex-column justify-content-center py-2 mr-1">
			                 <input type="hidden" name="poolId" value="${el._id}">
			                 <label class="btn btn-secondary m-0" title="Load CSV">
			                   <input type="file" name="filename"  hidden onchange="this.form.submit();">
			                   <i class="fas fa-file-upload"></i>
			                 </label>
			               </form>
						   <div  class="d-flex flex-column justify-content-center py-2">
								<button class="btn btn-danger m-0 list-group-item-delete" onclick="$.get('/api/poolRemove?poolId=${
									el._id
								}'); setTimeout(() => {loadPool()}, 50);">
									<i class="fas fa-trash-alt"></i>
								</button>
							</div>
			             </div>
						 <!-- Модальное окно -->
						<div class="modal fade" id="modal${
							el._id
						}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
							<div class="modal-dialog modal-dialog-centered">
								<div class="modal-content">
								<div class="modal-header">
									<h5 class="modal-title" id="exampleModalLabel">Stream link</h5>
									<button type="button" class="close" data-dismiss="modal" aria-label="Close">
									<span aria-hidden="true">&times;</span>
									</button>
								</div>
								<div class="modal-body ">
									<div d-flex flex-column>
										<input type="text" readonly id="stream${
											el._id
										}" class="w-100 form-control" value='${
							window.location.href
						}api/stream/${el._id}'>
										<h5 class="mt-3">
											Example
										</h5>
							
												type:"POST", <br/>contentType:"application/json; charset=utf-8"
							
										<div class="bg-secondary p-2 rounded">
											<code class="text-light">
												{<br>
													"object": "Someone",<br>
													"event": "Opennn",<br>
													"timestamp":"2006-01-02 15:04:05"<br>
												}
											</code>
										</div>
									</div>
								</div>
								<div class="modal-footer">
									<button type="button" class="btn btn-secondary" onclick="copy('stream${
										el._id
									}')">Copy</button>
								</div>
								</div>
							</div>
						</div>
			           </div>
			           `;
						container.append(block);
					}
				});
			}
			// INIT LOAD POOL LIST
			loadPool();
			// POOL REALOAD BUTTON
			$("#poolReload").click(function () {
				loadPool();
			});
			// CREATE NEW POOL
			$("#createNewPool").click(function () {
				let newPoolName = $("#newPoolName").val();
				let newPoolDescription = $("#newPoolDescription").val();
				if (newPoolName && newPoolDescription) {
					$.get(
						`/api/poolCreate?name=${newPoolName}&description=${newPoolDescription}`,
						() => {
							setTimeout(() => {
								loadPool();
							}, 100);
						}
					);
				} else {
					alert("Error! Please try again later...");
					return false;
				}
			});
			// AUTOUPDATE
			let intID;
			$("#graphUpdate").change(function () {
				if (selectedPool) {
					if (this.checked) {
						console.log("AutoUpdate Enabled");
						intID = setInterval(function () {
							console.log("AutoUpdate Chart");
							// $("#processGraph-tab").click();
							// $.get(
							// 	`/api/poolAggregate?poolId=${selectedPool}${
							// 		filterParam ? `&${filterParam}` : ""
							// 	}`,
							// 	function (data) {
							// 		initChart(data.Filename);
							// 	}
							// );
							$.ajax({
								url: `/api2/poolAggregate`,
								type: "POST",

								data: JSON.stringify({ poolId: `${selectedPool}` }),
								contentType: "application/json; charset=utf-8",
								// dataType: "json",
								success: function (data) {
									initChart(data);
								},
							});
						}, 10000);
					} else {
						console.log("Disabled AutoUpdate");
						clearInterval(intID);
					}
				} else {
					alert("Data is not set.");
					this.checked = false;
				}
			});
		</script>
		<!-- Filter -->
		<script>
			// GENERATE EVENT LIST
			function filterEventsList(data) {
				let select = $("#filterEvents");
				$(select).html("");
				dragEvent.stop();
				data.forEach((el) => {
					let option = `<li class="js-item">
							<label>
								<input type="checkbox" name="events" hidden value="${el._id}" />
								<span>${el._id}</span>
							</label>
						</li>`;
					select.append(option);
				});

				dragEvent = new DragSelect({
					area: document.querySelector(".js-select-events"),
					selectables: document.querySelectorAll(".js-item"),
					draggability: false,
					callback: function (e) {
						let arr = document.querySelectorAll(".js-item");
						arr.forEach((element) => {
							element.querySelector("input").checked = false;
						});
						e.forEach((element) => {
							element.querySelector("input").checked = true;
						});
					},
				});
				// dragEvent.start;
			}
			// GENERATE CASE LIST
			function filterCaseList(data) {
				let select = $("#filterCase");
				$(select).html("");
				// select.append(`<option value="all">All</option>`);
				data.forEach((el) => {
					let option = `<option value="${el._id}">${el._id}</option>`;
					select.append(option);
				});
			}
			function filterGetData(min, max) {
				// GENERATE DATA RANGE
				dataStart = min;
				dataEnd = max;
				dataRangeStart = min;
				dataRangeEnd = max;

				filterDataRange.data("ionRangeSlider").update({
					min: Date.parse(dataStart),
					max: Date.parse(dataEnd),
					from: Date.parse(dataStart),
					to: Date.parse(dataEnd),
				});
				console.log(Date.parse(dataStart));
			}

			let filterDataRange = $("#filterDataRange");
			let filterSubmit = $("#filterSubmit");

			function dateToTS(date) {
				return date.valueOf();
			}

			function tsToDate(ts) {
				var d = new Date(ts);
				// return new Date(ts).toISOString();
				return d.toLocaleDateString("en-US", {
					year: "numeric",
					month: "short",
					day: "numeric",
					hour: "numeric",
				});
			}

			filterDataRange.ionRangeSlider({
				skin: "big",
				type: "double",
				drag_interval: true,
				min: Date.parse(dataStart),
				max: Date.parse(dataEnd),
				from: Date.parse(dataStart),
				to: Date.parse(dataEnd),
				prettify: tsToDate,
				onFinish: function (data) {
					dataRangeStart = new Date(data.from).toISOString();
					dataRangeEnd = new Date(data.to).toISOString();
				},
			});

			// FILTER BUTTON
			$(filterSubmit).click(function () {
				let eventsChoosen = document.querySelectorAll(
					"#filterEvents input:checked"
				);
				let eventsVal = [];

				eventsChoosen.forEach((element) => {
					let result = element.value;
					eventsVal.push(result);
				});

				console.log(eventsChoosen, eventsVal);

				let casesVal = $("#filterCase").val();
				if ($("#graphUpdate").is(":checked")) {
					$("#graphUpdate").prop("checked", false);
					clearInterval(intID);
					console.log("AutoUpdate disabled");
				}

				let json = {
					dataRangeStart: dataRangeStart,
					dataRangeEnd: dataRangeEnd,
					events: eventsVal,
					cases: casesVal,
				};

				filterParam = $.param(json);
				$.ajax({
					url: `/api2/poolAggregate`,
					type: "POST",
					data: JSON.stringify({ poolId: `${selectedPool}` }),
					contentType: "application/json; charset=utf-8",
					// dataType: "json",
					success: function (data) {
						initChart(data);
					},
				});
				// $.get(
				// 	`/api/poolAggregate?poolId=${selectedPool}&${filterParam}`,
				// 	function (data) {

				// 	}
				// );
			});

			$(".js-example-basic-single").select2({
				placeholder: "All",
			});
		</script>

		<script>
			let ctx = document.getElementById("myChart").getContext("2d");
			labels = cubeLabelYears;

			let myChart = new Chart(ctx, {
				type: "line",
				data: {
					labels: labels,
					datasets: [
						{
							label: "Total Sum",
							data: cubeDataSetBars,
							borderColor: ["rgba(255, 99, 132, 1)"],
							backgroundColor: ["rgba(255, 99, 132, 0.4)"],
							stack: "combined",
							type: "bar",
							yAxisID: "y",
						},
						{
							label: "Cases count",
							data: cubeDataSetLine,
							fill: false,
							borderColor: "rgb(75, 192, 192)",
							stack: "combined",
							yAxisID: "y2",
							tension: 0.3,
						},
					],
				},
				options: {
					plugins: {
						title: {
							display: false,
						},
					},

					scales: {
						y: {
							type: "linear",
							position: "left",
							ticks: {
								color: "rgba(255, 99, 132, 1)",
							},
						},
						y2: {
							type: "linear",
							position: "right",
							ticks: {
								color: "rgb(75, 192, 192)",
							},
							grid: {
								drawOnChartArea: false,
							},
						},
					},
				},
			});

			function getDataCube() {
				cubeLabelMonthNumb = [];
				cubeLabelMonth = [];
				cubeLabelYears = [];
				cubeDataBarYears = [];
				cubeLabelDays = [];
				cubeDataBarDays = [];
				initCubeChart([], [], []);
				$.get(`/api/chartByYear?poolId=${selectedPool}`, function (data) {
					$("#cubeYears").html("");
					cubeLabelYears = data.Period;
					cubeDataBarYears = data.Count;
					cubeDataLineYears = data.CasesCount;
					cubeLabelYears.forEach((el) => {
						opt = `<option value="${el}">${el}</option>`;
						$("#cubeYears").append(opt);
					});
					initCubeChart(cubeLabelYears, cubeDataBarYears, cubeDataLineYears);
				});
			}

			function initCubeChart(labels, dataBar, dataLine) {
				cubeDataSetBars = dataBar;
				cubeDataSetLine = dataLine;
				myChart.data.labels = labels;
				myChart.data.datasets[0].data = cubeDataSetBars;
				myChart.data.datasets[1].data = cubeDataSetLine;
				myChart.update();

				let cubeTable = $("#cubeViewTable");
				cubeTable.html("");

				for (let i = 0; i < labels.length; i++) {
					let elLable = labels[i];
					let elTotalSum = dataBar[i];
					let elSumCases = dataLine[i];
					let tableRow = `<tr>
											<th scope="row">${elLable}</th>
											<td>${elSumCases}</td>
											<td>${elTotalSum}</td>
										</tr>`;

					cubeTable.append(tableRow);
				}
			}
			// Фильтра

			function checkCubeFilter() {
				if ($("#cubeFilter").val() == "months") {
					$.get(
						`/api/chartByMonth?poolId=${selectedPool}&year=${Number(
							$("#cubeYears").val()
						)}`,
						function (data) {
							$("#cubeMonth").prop("disabled", true);
							$("#cubeYears").prop("disabled", false);
							$("#cubeMonth").html("");
							cubeLabelMonth = [];
							cubeLabelMonthNumb = data.Period;
							data.Period.forEach((el) => {
								switch (el) {
									case 1:
										s = "January";
										break;
									case 2:
										s = "February";
										break;
									case 3:
										s = "March";
										break;
									case 4:
										s = "April";
										break;
									case 5:
										s = "May";
										break;
									case 6:
										s = "June";
										break;
									case 7:
										s = "July";
										break;
									case 8:
										s = "August";
										break;
									case 9:
										s = "September";
										break;
									case 10:
										s = "October";
										break;
									case 11:
										s = "November";
										break;
									case 12:
										s = "December";
										break;
								}
								cubeLabelMonth.push(s);
								opt = `<option value="${el}">${s}</option>`;
								$("#cubeMonth").append(opt);
							});
							cubeDataBarMonth = data.Count;
							cubeDataLineMonth = data.CasesCount;
							if ($("#cubeYears").val()) {
								initCubeChart(
									cubeLabelMonth,
									cubeDataBarMonth,
									cubeDataLineMonth
								);
							}
						}
					);
					$("#cubeMonth").prop("disabled", true);
				} else if ($("#cubeFilter").val() == "days") {
					$("#cubeMonth").prop("disabled", false);
					$("#cubeYears").prop("disabled", false);
					$("#cubeYears").change(function () {
						$("#cubeMonth").prop("disabled", true);
						$.get(
							`/api/chartByMonth?poolId=${selectedPool}&year=${Number(
								$("#cubeYears").val()
							)}`,
							function (data) {
								$("#cubeMonth").prop("disabled", false);
								$("#cubeMonth").html("");
								data.Period.forEach((el) => {
									switch (el) {
										case 1:
											s = "January";
											break;
										case 2:
											s = "February";
											break;
										case 3:
											s = "March";
											break;
										case 4:
											s = "April";
											break;
										case 5:
											s = "May";
											break;
										case 6:
											s = "June";
											break;
										case 7:
											s = "July";
											break;
										case 8:
											s = "August";
											break;
										case 9:
											s = "September";
											break;
										case 10:
											s = "October";
											break;
										case 11:
											s = "November";
											break;
										case 12:
											s = "December";
											break;
									}
									cubeLabelMonth.push(s);
									opt = `<option value="${el}">${s}</option>`;
									$("#cubeMonth").append(opt);
								});
								nubOfDay = 0;
								cubeLabelDays = [];
								nubOfDay = new Date(
									Number($("#cubeYears").val()),
									Number($("#cubeMonth").val()),
							0
								).getDate();
								for (let i = 1; i <= nubOfDay; i++) {
									cubeLabelDays.push(i);
								}
							}
						);
					});
					$.get(
						`/api/chartByDay?poolId=${selectedPool}&year=${Number(
							$("#cubeYears").val()
						)}&month=${Number($("#cubeMonth").val())}`,
						function (data) {
							cubeLabelDays = data.Period;
							cubeDataBarDays = data.Count;
							cubeDataLineDays = data.CasesCount;
							if ($("#cubeMonth").val()) {
								initCubeChart(
									cubeLabelDays,
									cubeDataBarDays,
									cubeDataLineDays
								);
							}
						}
					);
				} else if ($("#cubeFilter").val() == "years") {
					$("#cubeMonth").prop("disabled", true);
					$("#cubeYears").prop("disabled", true);
					initCubeChart(cubeLabelYears, cubeDataBarYears, cubeDataLineYears);
				}
			}

			$("#cubeFilterSubmit").click(function () {
				checkCubeFilter();
				if ($("#cubeFilter").val() == "months") {
					initCubeChart(cubeLabelMonth, cubeDataBarMonth, cubeDataLineMonth);
				} else if ($("#cubeFilter").val() == "days") {
					initCubeChart(cubeLabelDays, cubeDataBarDays, cubeDataLineDays);
				} else if ($("#cubeFilter").val() == "years") {
					getDataCube();
					initCubeChart(cubeLabelYears, cubeDataBarYears, cubeDataLineYears);
				}
			});
		</script>

	</body>
</html>
